---
layout: post
title:  "도메인 주도 설계 14 - 모델의 무결성 유지"
date:   2019-06-15
desc:  "도메인 주도 설계 14 - 모델의 무결성 유지"
keywords: "도메인 주도 설계, DDD, Domain, Domain Driven Design, Bounded Context, Context Map, Shared Kernel, Conformist, Anticorruption Layer, Separate Ways, Published Language"
categories: [Programming]
tags: [DDD, Domain, Domain Driven Design]
icon: icon-html
---

시스템이 너무 복잡해져서 개별 객체 수준에서도 완벽히 파악되지 않을 경우 커다란 모델을 솜씨있게 다루고 이해하기 위한 기법이 필요하다. 보통 큰 시스템의 목표는 전체 업무 도메인을 아우르는 긴밀히 통합된 시스템이다. 그러나 이런 전체 모델은 대부분 규모가 크고 복잡하여 하나의 단위로 관리하거나 이해하는 것조차 불가능하다. 쉽지 않은 것은 **긴밀히 통합하는 것에서 오는 이점을 잃어버리지 않으면서도 모듈화를 달성하여 갖가지 하위 모듈, 시스템들이 다양한 업무 영역을 위해 조화롭게 상호작용하게끔 만드는 것이다.**

모놀리식 형태의 전체를 포괄하는 도메인 모델은 비대해서 다루기 힘들고, 미묘한 중복이나 모순된 부분이 있을 것이다. 한편으로 규모가 작고 역할이 뚜렷이 구분되는 하위 시스템들이 서로 임시방편적으로 구현된 인터페이스를 토대로 통합된다면 통합이 이루어지는 모든 곳에서 모델의 일관성 문제가 발생할 것이다. 이런 대규모의 시스템에서도 도메인 주도 설계는 구현과 동떨어지는 모델을 만들어 내지 않는다.

**전략적 설계 원칙은 설계 의사결정이 중요한 상호운용성과 상승효과를 잃지 않으면서 각 하위 부분간의 상호의존성을 줄이고 각 부분의 명확성을 향상시키게끔 이끌어야 한다.** 그려면서도 모델에 초점을 맞추어 시스템의 개념적 핵심, 비전을 포착해야 한다.

**성공적인 모델은 규모와 상관없이 모순되거나 정의가 겹치지 않고 처음부터 끝까지 논리적인 일관성을 지녀야 한다.**

<br>

# 모델의 무결성 유지

여러 팀이 동시에 일을 진행하는 프로젝트가 있을 때, 각 팀의 개발하는 부분의 맥락에서 구현되는 객체나 속성들이 전체 도메인 관점에서 보면 서로 충돌을 일으킬 때가 있다. 이런 경우에 **도메인 모델의 무결성을 해치지 않는 방법은 각 팀이 개발하는 업무에 대한 도메인 모델이 적용되는 경계를 명확히 하는 것이다.**

**모델의 가장 근본적인 요구사항은, 모델은 내적으로 일관성을 유지해야 하고 모델의 용어는 언제나 의미가 동일해아하며 어떠한 모순된 규칙도 있어서는 안된다는 것이다.**

> 각 용어가 모호하지 않고 모순되는 규칙이 없는 모델의 내적 일관성을 **단일화**라고 한다. 모델에 논리적인 일관성이 없다면 그 모델은 아무런 의미가 없다.

큰 규모의 업무를 다루는 시스템이라면 전체 도메인을 아우르는, 모순되거나 용어의 정의가 겹치지 않고 일관성이 있는 단일 모델이 이상적이겠지만 현실은 그렇지 않다. 서로 다른 팀이 협업하는 큰 규모의 프로젝트에서 모델의 단일화를 유지하기가 쉽지 않다. **대규모의 시스템에서는 도메인 모델을 완전하게 단일화하는 것은 타당하지 않거나 비용 대비 효과적이지 않다.** 우리는 이를 위해 서로 다른 하부 시스템에 적용되는 여러 도메인 모델 간의 경계와 관계를 설정하는 수단이 필요하다.

<br>

## Bounded Context

**규모가 큰 프로젝트에서는 다수의 도메인 모델이 사용되기 마련인데, 개별적인 모델을 기반으로 작성된 코드가 한 데 섞이면 많은 버그가 발생하고 신뢰성이 떨어지는, 이해하기 어려운 소프트웨어가 만들어진다.** 그 뿐만 아니라 팀 끼리, 아니면 팀 내의 팀원들끼리 의사소통이 혼란스러워질 수도 있다.

다수의 모델으로 인해 발생하는 문제를 해결하기 위해서는 **모델의 단일화를 유지할 수 있는, 소프트웨어 내의 제한된 부분으로 모델의 범위를 명확하게 정의해야 한다.** 어느 특정 모델이 적용될 수 있는 범위를 Context라고 하는데, 이 범위의 경계 안에서의 모델은 일관된 상태로 유지되며 경계의 바깥의 무언가에 의해 초점이 흐려지거나 혼란스러워져서는 안된다.

특정 모델의 적용 범위를 제한하는 Bounded Context를 통해, 모델의 일관성이 적용되어야 할 부분과 서로 다른 Context끼리 어떤 식으로 관련되어 있는지 명확히 이해할 수 있도록 도와준다. Context 내에서는 도메인 모델이 논리적으로 일관성 있는 상태가 유지된다.

**Bounded Context를 정의함으로써 얻을 수 있는 것은 모델을 일관성 있게 유지함으로써 나타나는 모델의 명확성이다.** 모델이 적용되는 범위, Context를 명시적으로 정의하라. Context의 경계를 팀 조직, 애플리케이션의 특정 부분에서의 사용법이나 코드, 데이터베이스 스키마와 같은 물리적인 형태의 관점에서 명시적으로 설정하라.

경계는 특별한 곳이다. 서로 다른 Bounded Context끼리 간의 관계에 대해서는 항상 주의가 필요하다. **Context Map은 여러 Context 사이의 연결이라는 큰 그림을 제시하면서 각 Context가 차지 하는 영역을 보여준다. 그리고 일단 Context가 제한되면 지속적인 통합 (Continuous Integration) 프로세스를 토대로 모델의 단일화를 유지할 수 있다.**


<br>

### Bounded Context 안의 균열 인식

모델의 단일화가 깨진다면 어떤 모습을 띠게 될까? 여러 징후를 바탕으로 알 수 있는데, 그 중 하나는 바로 코드로 작성된 인터페이스가 서로 맞지 않는 경우이다. 또 **중복된 개념**이나 **허위 동족 언어(false cognates)**이 있다.

중복된 개념이란 실제로는 같은 개념을 나타내는 두 개의 모델 요소 및 그에 따른 구현 코드가 존재하는 것이다. 이러면 요구사항이 변경될 때마다 두 군데 이상을 갱신하고 변환해야 한다.

허위 동족 언어는 같은 용어나 구현 객체를 사용하는 두 사람이 서로 같은 것을 이야기하고 있다고 생각하지만, 실제로는 그렇지 않은 경우를 말한다. 이러한 개념상의 충돌은 알아차리기 힘들 뿐만 아니라, 서로의 코드를 침범하게 되고 데이터베이스에 이상한 불일치가 생길 뿐만 아니라 팀 내 의사소통이 혼란스러워질 수 있다.

<br>

## 지속적인 통합 (Continuous Integration)

> Bounded Context를 정의했다면 이를 **건전한 상태**로 유지해야 한다.

다수의 사람이 한 Bounded Context 내에서 작업할 경우, 모델이 단편화될 가능성이 있다. 팀의 규모와 상관없이 서너 명 정도에 달하는 소수의 인원이더라도 심각한 문제에 마주칠 수 있다. 이걸 피한답시고 너무 작은 Context로 쪼갠다면 가치 있는 수준의 통합과 응집성을 잃어버릴 수도 있다.

다른 사람이 모델링한 객체나 상호작용의 의도를 완전히 이해하지 못한 채로 객체를 수정해서 원래의 목적으로 사용하지 못하거나, 다루고자 하는 개념이 이미 모델의 다룬 부분에 있는데도 이 사실을 모른채 중복 구현할 수도 있다. 

규모와는 상관없이 의사소통을 촉진하고 복잡도를 줄일 방법이 필요하다. **Context 내의 모든 작업을 병합하고 일관성있게 유지하는 지속적인 통합 프로세스를 통해 이러한 균열을 빠르게 정정해나가야 한다.** 개념은 팀 구성원 간의 부단한 의사소통을 토대로 통합되고, 끊임없이 변화하는 모델을 함께 이해하고 발전시켜야 한다. 가장 근본적인 것은 Ubiquitous Language를 다듬는 것이다. 그리고 구현 산출물은 모델 내의 균열을 방지하는 체계적인 병합 / 빌드 / 테스트 프로세스를 통해 통합하면 된다.

다음과 같은 개발 프로세스로 효과적으로 통합시킬 수 있다.

1. 단계적이고 재생 가능한 병합 / 빌드
2. 자동화된 테스트 스위트
3. 수정사항이 통합되지 않은 상태를 비교적 짧게 유지하는 업무 프로세스
4. 모델과 애플리케이션에 대해 논의할 때 Ubiquitous Language를 지속적으로 사용

**모델의 단편화가 발생했다는 사실을 빠르게 알려줄 수 있는 자동화된 테스트와 함께 모든 코드와 그 밖의 구현 산출물을 빈번하게 병밥하는 프로세스를 수립하라. 모델의 개념이 각 팀원의 머릿속에서 발전해감에 따라, 모델에 관한 각자의 시각 차이를 해소하기 위해 끊임없이 Ubiquitous Language를 사용하라.**

<br>

## Context Map

![00.png](/static/assets/img/blog/programming/2019-06-15-domain_driven_design_14/00.png)

개별적인 Bounded Context 만으로는 전체를 조망할 수 없다. 다른 팀에 속한 사람들은 Context 간의 경계를 인식하지 못할 것이며, 자신도 모르게 Context의 경계를 흐리게 하거나 연결되는 방식을 복잡하게 바꿀 것이다. 서로 다른 Context를 연결해야 하는 경우 Context는 서로에게 스며드는 경향이 있다.

Bounded Context 간에 코드를 재사용하는 것은 모델의 모호함을 초래할 수 있어 피해야 한다. **번역 과정을 통해 서로 다른 Context를 통합해야 하며, 각 Context 간의 관계를 정의하고 프로젝트 상의 모든 모델 Context를 아우르는 전체적인 뷰, Context Map을 만들면 혼란을 줄일 수 있다.**

Context Map은 프로젝트 관리와 소프트웨어 설계 영역 사이에 걸쳐 있는 개념이다. 대개 큰 프로젝트의 각 Context의 경계는 팀 조직이 어떻게 구성되어 있느냐에 따라 정해질 수 있다.

프로젝트 상의 유효한 모델을 식별하고 각 Bounded Context를 정의하라. 그리고 각 Bounded Context에 이름을 부여하고, 이 이름을 Ubiquitous Language의 일부로 포함시켜라. 의사소통을 위해 Context 간의 번역에 대한 윤곽을 명확히 표현하고, Context 끼리 공유해야 하는 정보를 강조하여 모델과 모델이 만나는 경계 지점을 서술하라.
